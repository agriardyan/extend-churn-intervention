# Anti-Churn Pipeline Configuration
# This file defines the rules and actions for the anti-churn system.

# Rules detect churn signals and trigger actions
rules:
  # Rage Quit Rule - Detects when a player quits after consecutive losses
  - id: rage-quit
    type: rage_quit
    enabled: true
    actions: [comeback-challenge]  # Actions to execute when triggered
    parameters:
      threshold: 3  # Number of consecutive losses before triggering

  # Losing Streak Rule - Detects extended losing streaks
  - id: losing-streak
    type: losing_streak
    enabled: true
    actions: [comeback-challenge]  # Same actions as rage quit
    parameters:
      threshold: 5  # Number of consecutive losses

  # Session Decline Rule - Detects significant drop in play sessions
  - id: session-decline
    type: session_decline
    enabled: true
    actions: [comeback-challenge]  # Only challenge, no item grant
    parameters:
      decline_threshold: 0.5  # 50% decline from last week
      min_sessions_last_week: 3  # Minimum sessions last week to qualify

  # Challenge Completion Rule - Grants item upon challenge completion
  # This rule listens for challenge completion events. When a player
  # completes the comeback challenge, they are rewarded with an item.
  # The rule should check whether user has the challenge. 
  # Normally challenge created by rules like losing_streak, rage_quit, session_decline.
  - id: challenge-completion
    type: challenge_completion
    enabled: true
    actions: [grant-item]  # Grant item upon challenge completion
    parameters:
      wins_needed: 3
      challenge_id: comeback-challenge

  # Clan Activity Rule - Detects players in low-activity clans
  # Uses external ClanService to fetch clan activity data (demonstrates lazy loading)
  # Only triggers if player is in a clan with fewer active members than threshold
  - id: clan-activity
    type: clan_activity
    enabled: false  # Disabled by default (requires ClanService implementation)
    actions: [comeback-challenge]  # Re-engage with challenge
    parameters:
      min_active_members: 3  # Minimum active members in last 7 days

# Actions are executed when rules trigger
actions:
  # Comeback Challenge - Creates a time-limited challenge
  - id: comeback-challenge
    type: comeback_challenge
    enabled: true
    parameters:
      wins_needed: 3
      duration_days: 7
      cooldown_hours: 168  # 7 days between challenges

  # Grant Item - Rewards the player with an item
  - id: grant-item
    type: grant_item
    enabled: true
    parameters:
      item_id: ${REWARD_ITEM_ID:COMEBACK_REWARD}
      quantity: 1
      source: "anti_churn_system"
      test_mode: ${TEST_MODE:false}  # Set to true to test without actual grants
